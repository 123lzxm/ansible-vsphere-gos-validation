# Copyright 2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
- name: "Add registry to download and install the PCA2023-signed boot manager"
  include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: >-
      reg add HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Secureboot /v AvailableUpdates /t REG_DWORD /d 0x100 /f

- name: "Restart guest OS"
  include_tasks: restart_os_twice.yml

- name: "Copy new boot manager bootmgfw.efi"
  include_tasks: ../utils/win_execute_cmd.yml
  vars:
    win_powershell_cmd: >-
      mountvol s: /s;
      copy S:\EFI\Microsoft\Boot\bootmgfw.efi c:\bootmgfw_2023.efi

- name: "Take snapshot after installing new boot manager"
  include_tasks: ../../common/vm_take_snapshot.yml
  vars:
    snapshot_name: "PCA2023SignedBootmgfw"
    snapshot_description: "New bootmgfw.efi signed by PCA2023 is installed"
