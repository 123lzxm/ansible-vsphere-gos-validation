# Copyright 2023-2024 VMware, Inc.
# SPDX-License-Identifier: BSD-2-Clause
---
# Description:
#   This case is to test Microsoft's Windows updates.
#   Install Windows .msu update package.
#
- name: windows_test_vbs_rollback
  hosts: localhost
  gather_facts: no
  tasks:
    - name: "Test case block"
      block:
        - name: "Test setup"
          include_tasks: ../setup/test_setup.yml
          vars:
            create_current_test_folder: true

        - name: "Install the online updates for guest OS"
          include_tasks: install_online_updates.yml

        - name: "Check if windows updates is installed successfully"
          ansible.builtin.assert:
            that:
              - win_online_updates_succeed
            fail_msg: "The latest Windows Updates should be installed before applying the mitigation."
            success_msg: "The latest Windows Updates have been installed."

        - name: "Skip test case for 32bit OS"
          include_tasks: ../../common/skip_test_case.yml
          vars:
            skip_msg: >-
              Skip test case due to known issue PR 3369453 for x86 32bit OS.
            skip_reason: "Skipped"
          when: guest_os_ansible_architecture == "32-bit"

        - name: "Skip test case for BIOS OS"
          include_tasks: ../../common/skip_test_case.yml
          vars:
            skip_msg: >-
              Skip test case due to firmware is BIOS which does not support secure boot.
            skip_reason: "Skipped"
          when: vm_firmware == 'bios'

        - name: "Skip test case for OS lower than Windows 10 1809 and Windows Server 2019"
          include_tasks: ../../common/skip_test_case.yml
          vars:
            skip_msg: >-
              Skip test case due to the update only applicable for Windows 10 1809 and later, Windows Server 2019 and later.
            skip_reason: "Skipped"
          when: guest_os_ansible_distribution_ver is version('10.0.17763.0', '<')

        - name: "Test the mitigation"
          include_tasks: test_vbs_rollback.yml

        - name: "Reset base snapshot after installing the .msu file"
          include_tasks: ../../common/reset_base_snapshot.yml
          vars:
              base_snapshot_description: "{{ vbs mitigation deployed }}"

        - name: "Save the new name of the old base snapshot"
          ansible.builtin.set_fact:
            win_update_snapshot_name: "{{ old_snapshot_new_name }}"
      rescue:
        - name: "Test case failure"
          include_tasks: ../../common/test_rescue.yml
          vars:
            exit_testing_when_fail: true
